---
title: Architecture
description: System architecture, rendering pipeline, data flow, and high-level component overview.
---

# Architecture

Gerbtrace is built as a **static Nuxt SPA** (web) and a **Tauri desktop app** that bundles the same frontend. Collaboration features are backed by a **self-hosted Supabase** instance.

## High-level components

The system consists of three main deployment targets:

- **Web SPA** – static files hosted on DigitalOcean Spaces, served via CDN
- **Desktop app** – Tauri 2 (Rust) wrapping the same Nuxt frontend, distributed via GitHub Releases
- **API server** – self-hosted Supabase on a DigitalOcean droplet (PostgreSQL, Storage, Realtime, Edge Functions, Auth)

The browser/desktop client communicates with the API server over HTTPS for data operations and WSS for real-time subscriptions. The desktop app additionally checks GitHub Releases for auto-updates.

## Gerber rendering pipeline

Raw Gerber and drill files are processed through a multi-stage pipeline:

1. **Tokenizer** – raw Gerber/drill text is split into tokens
2. **Parser** – tokens are parsed into a typed AST (Abstract Syntax Tree) of Gerber commands
3. **Plotter** – the AST is transformed into an `ImageTree` of drawing primitives (arcs, lines, regions, flashes)
4. **Renderer** – the `ImageTree` is drawn onto an HTML5 Canvas element

The pipeline lives in `lib/gerber/` (tokenizer, parser, plotter) and `lib/renderer/` (canvas renderer, realistic renderer, SVG exporter, pixel diff).

### Renderer variants

| Renderer | Location | Purpose |
|---|---|---|
| Canvas 2D | `lib/renderer/canvas-renderer.ts` | Standard layer rendering |
| Realistic | `lib/renderer/realistic-renderer.ts` | 3D-style PCB appearance |
| SVG Exporter | `lib/renderer/svg-exporter.ts` | SVG export |
| Pixel Diff | `lib/renderer/pixel-diff.ts` | Comparison mode pixel differencing |

## Data persistence

| Data | Local (browser/desktop) | Team (cloud) |
|---|---|---|
| Projects | IndexedDB via Dexie.js | Supabase Postgres |
| Files | IndexedDB via Dexie.js | Supabase Storage |
| Packages | Static JSON (`public/packages/`) | Supabase JSONB (`team_packages`) |
| THT Packages | Static JSON (`public/packages/tht-libraries/`) | Supabase JSONB (`team_tht_packages`) |
| User preferences | localStorage | – |

Local projects work entirely offline. Team projects require authentication and a connection to the Supabase API.

## Package system

Built-in packages are organized as a library tree under `public/packages/libraries/`. At runtime, the library tree manifest (`_tree.json`) is loaded, and individual packages are fetched on demand.

Team packages are stored in Supabase as JSONB and merged into the in-app library at runtime. Export to `.pck` uses the TPSys serializer in `app/utils/pck-serializer.ts`.

All packages use TPSys package types exclusively. See [Package Definitions](/docs/reference/package-definitions) for the type system.

## Collaboration and sync

- **Auth** – Supabase Auth with GitHub OAuth, email/password, and magic link flows
- **Teams and projects** – stored in Postgres, shared via Supabase Realtime subscriptions
- **Presence** – tracked via Realtime channels to show who is viewing a project
- **Files** – stored in Supabase Storage (`gerber-files` bucket), metadata tracked in Postgres
- **Row-level security** – all tables use RLS policies that enforce team membership and role-based access

## Database schema

The database is defined through idempotent SQL migrations in `supabase/migrations/`. Key tables:

| Table | Purpose |
|---|---|
| `profiles` | User profiles (auto-created on signup) |
| `teams` | Team definitions with subdomain slugs |
| `team_members` | User-team relationships with roles |
| `team_invitations` | Pending email invitations |
| `projects` | PCB projects with BOM, PnP, panel, and pricing data (JSONB) |
| `project_files` | Gerber/drill file metadata |
| `project_documents` | PDF document metadata |
| `team_packages` | Custom SMD package definitions |
| `team_tht_packages` | Custom THT package definitions |

## Edge functions

Supabase Edge Functions (Deno runtime) handle server-side operations:

| Function | Purpose |
|---|---|
| `admin-password-reset` | Admin-initiated password resets |
| `handle-team-join` | Auto-join via email domain matching |
| `send-invitation` | Send team invitation emails (via Resend API) |
| `elexess-exchange-rate` | Proxy for Elexess pricing API (CORS bypass) |

## Frontend structure

The Nuxt app follows a composable-driven architecture:

- **Pages** (`app/pages/`) – route definitions for viewer, compare, team, auth, and docs
- **Components** (`app/components/`) – organized by feature area (viewer, compare, import, packages, docs, shared)
- **Composables** (`app/composables/`) – state management and business logic (useProject, useBom, usePickAndPlace, useAuth, useTeamProjects, etc.)
- **Utils** (`app/utils/`) – pure functions for parsing, geometry, formatting, and conventions
