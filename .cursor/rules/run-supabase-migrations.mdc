---
description: How to apply Supabase migrations to the production droplet
globs: supabase/migrations/**/*.sql
alwaysApply: false
---

# Running Supabase Migrations on the Production Droplet

When a new migration file is created under `supabase/migrations/`, apply it directly to the production droplet. Do NOT wait for CI â€” the agent has SSH access.

## Droplet details

- **Host**: `167.172.166.141` (DigitalOcean droplet `supabase-gerbtrace`)
- **SSH user**: `root`
- **Supabase docker dir**: `/opt/supabase/docker`
- **Migration user**: `supabase_admin` (owns all `public` schema objects)
- **Bookkeeping user**: `postgres` (owns `schema_migrations`)

## Step-by-step

1. **Check which migrations are already applied:**

```bash
ssh root@167.172.166.141 "cd /opt/supabase/docker && docker compose exec -T db psql -U postgres -d postgres -tAc \"select name from public.schema_migrations order by name;\""
```

2. **Apply each pending migration** (in timestamp order, as `supabase_admin`):

```bash
cat supabase/migrations/<MIGRATION_FILE>.sql | ssh root@167.172.166.141 "cd /opt/supabase/docker && docker compose exec -T db psql -U supabase_admin -d postgres -v ON_ERROR_STOP=0"
```

3. **Record the migration** in the bookkeeping table (as `postgres`):

```bash
ssh root@167.172.166.141 "cd /opt/supabase/docker && docker compose exec -T db psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c \"insert into public.schema_migrations(name) values ('<MIGRATION_FILE>.sql') on conflict (name) do nothing;\""
```

4. **Verify** the migration is recorded:

```bash
ssh root@167.172.166.141 "cd /opt/supabase/docker && docker compose exec -T db psql -U postgres -d postgres -tAc \"select name from public.schema_migrations order by name;\""
```

## Important notes

- All DDL statements must be **idempotent** (`IF NOT EXISTS`, `CREATE OR REPLACE`, etc.).
- Apply migrations as `supabase_admin`, record them as `postgres`.
- The CI workflow (`.github/workflows/deploy-supabase.yml`) also applies migrations on push to `main`, so the bookkeeping table prevents double-application.
- If a migration produces `NOTICE: ... already exists, skipping` that is fine.
- If a migration produces `ERROR:` lines that are NOT "already exists" family, stop and investigate.
