---
description: Supabase migration authoring rules for Supabase Cloud
globs: supabase/migrations/**/*.sql
alwaysApply: false
---

# Supabase Migration Safety (Supabase Cloud)

Production Supabase runs on **Supabase Cloud** (project `gqrnlnlfidighosujpdb`).
Migrations are applied using the Supabase MCP `apply_migration` tool.

## Every statement must be idempotent

Migrations can be retried after partial failures. Every statement must tolerate re-runs:

- `CREATE TABLE` -> `CREATE TABLE IF NOT EXISTS`
- `CREATE FUNCTION` -> `CREATE OR REPLACE FUNCTION`
- `CREATE POLICY` -> wrap in `DO $$ ... IF NOT EXISTS (select from pg_policy ...) ...`
- `ALTER TABLE ADD COLUMN` -> `ADD COLUMN IF NOT EXISTS`
- `ALTER TABLE ADD CONSTRAINT` -> check `pg_constraint` first in a `DO` block
- `DELETE` dedup -> use `row_number()` with a stable tiebreaker (`ctid`) so re-runs are no-ops

## Schema cache

Supabase Cloud auto-reloads the PostgREST schema cache after migrations applied via the `apply_migration` MCP tool. No manual reload is needed.

## Verifying changes

After applying a migration, verify the schema change:

```
execute_sql(
  project_id: "gqrnlnlfidighosujpdb",
  query: "SELECT column_name, data_type FROM information_schema.columns WHERE table_schema='public' AND table_name='<table>';"
)
```

## Do NOT use SSH to the droplet

The old self-hosted droplet is **not** the production database. All database operations must target Supabase Cloud via MCP tools.
