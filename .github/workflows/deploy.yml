name: Deploy Web

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy Web to DigitalOcean Spaces
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build static site
        run: npx nuxt generate

      - name: Deploy to DigitalOcean Spaces
        uses: BetaHuhn/do-spaces-action@v2
        with:
          access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          space_name: ${{ secrets.DO_SPACES_BUCKET }}
          space_region: ${{ secrets.DO_SPACES_REGION }}
          source: .output/public/
          destination: /
          acl: public-read

      - name: Purge CDN cache (optional)
        if: env.DO_API_TOKEN != null && env.DO_CDN_ENDPOINT_ID != null
        run: |
          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/cdn/endpoints/${{ secrets.DO_CDN_ENDPOINT_ID }}/cache"